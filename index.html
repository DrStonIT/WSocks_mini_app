<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WSocks VPN Mini App</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.7.2/dist/axios.min.js"></script>
  <script src="https://unpkg.com/@twa-dev/sdk@7.10.0/dist/telegram-web-apps.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f0f4f8;
      color: #1f2a44;
    }
    .container {
      max-width: 420px;
      margin: 0 auto;
      min-height: 100vh;
      background-color: white;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      overflow-x: hidden;
    }
    .header {
      position: sticky;
      top: 0;
      background-color: #3b82f6;
      color: white;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      z-index: 10;
    }
    .header-title {
      flex: 1;
      font-size: 18px;
      font-weight: 600;
      text-align: center;
    }
    .back-button {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 4px 8px;
    }
    .content {
      padding: 16px;
    }
    .logo {
      text-align: center;
      margin-bottom: 16px;
    }
    .logo-text {
      font-size: 24px;
      font-weight: 700;
      color: #1f2a44;
    }
    .button {
      display: flex;
      align-items: center;
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 8px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.1s;
    }
    .button:hover {
      transform: translateY(-1px);
    }
    .button:active {
      transform: translateY(0);
    }
    .button-primary {
      background-color: #3b82f6;
      color: white;
    }
    .button-primary:hover {
      background-color: #2563eb;
    }
    .button-secondary {
      background-color: #6b7280;
      color: white;
    }
    .button-secondary:hover {
      background-color: #4b5563;
    }
    .button-success {
      background-color: #10b981;
      color: white;
    }
    .button-success:hover {
      background-color: #059669;
    }
    .button-danger {
      background-color: #ef4444;
      color: white;
    }
    .button-danger:hover {
      background-color: #dc2626;
    }
    .button-icon {
      margin-right: 8px;
      font-size: 20px;
    }
    .card {
      background-color: #f9fafb;
      padding: 16px;
      margin-bottom: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    .card p {
      font-size: 14px;
      margin: 4px 0;
      color: #374151;
    }
    .card b {
      color: #1f2a44;
    }
    .error {
      color: #dc2626;
      font-size: 14px;
      text-align: center;
      margin-bottom: 16px;
    }
    .loading {
      text-align: center;
      color: #6b7280;
      font-size: 16px;
      animation: pulse 1.5s infinite;
    }
    .link {
      color: #3b82f6;
      text-decoration: none;
      font-weight: 600;
    }
    .link:hover {
      text-decoration: underline;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .tooltip {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    .tooltip .tooltip-text {
      visibility: hidden;
      background-color: #1f2a44;
      color: white;
      text-align: center;
      border-radius: 4px;
      padding: 4px 8px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/javascript">
    const { useState, useEffect, createElement: h } = React;

    function App() {
      const [user, setUser] = useState(null);
      const [view, setView] = useState('main');
      const [subscriptions, setSubscriptions] = useState([]);
      const [referrals, setReferrals] = useState([]);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [paymentData, setPaymentData] = useState(null);
      const [selectedSub, setSelectedSub] = useState(null);

      const API_URL = 'https://wsocks-api-bot-kype.onrender.com';

      useEffect(() => {
        console.log('App starting...');
        if (!window.Telegram?.WebApp) {
          setError('Telegram Web App SDK не загружен');
          setLoading(false);
          return;
        }

        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        const initData = Telegram.WebApp.initData;
        console.log('InitData:', initData);

        if (!initData) {
          setError('Не удалось получить initData');
          setLoading(false);
          return;
        }

        setLoading(true);
        axios.post(`${API_URL}/api/auth`, { init_data: initData }, {
          headers: { 'Cache-Control': 'no-cache' }
        })
          .then(({ data }) => {
            console.log('Auth response:', data);
            setUser(data.user);
            setLoading(false);
          })
          .catch(err => {
            console.error('Auth error:', err);
            setError(`Ошибка авторизации: ${err.response?.data?.detail || err.message}`);
            setLoading(false);
          });
      }, []);

      const fetchSubscriptions = async () => {
        if (!user) {
          setError('Пользователь не авторизован');
          return;
        }
        setLoading(true);
        try {
          const response = await axios.get(`${API_URL}/api/subscriptions?tg_id=${user.telegram_id}`, {
            headers: { 'Cache-Control': 'no-cache' }
          });
          console.log('Subscriptions response:', response.data);
          setSubscriptions(response.data.subscriptions || []);
          setView('subscriptions');
        } catch (err) {
          console.error('Subscriptions error:', err);
          setError(`Ошибка получения подписок: ${err.response?.data?.detail || err.message}`);
        } finally {
          setLoading(false);
        }
      };

      const initiatePayment = async (days, isExtension = false, email = null) => {
        if (!user) {
          setError('Пользователь не авторизован');
          return;
        }
        setLoading(true);
        setError(null);
        try {
          const endpoint = isExtension ? '/api/extend-subscription' : '/api/buy-subscription';
          const payload = isExtension 
            ? { tg_id: user.telegram_id, email, days }
            : { tg_id: user.telegram_id, days };
          const response = await axios.post(`${API_URL}${endpoint}`, payload);
          console.log('Payment response:', response.data);
          setPaymentData({ ...response.data, isExtension });
          setView('payment');
        } catch (err) {
          console.error('Payment error:', err);
          setError(`Ошибка инициации оплаты: ${err.response?.data?.detail || err.message}`);
        } finally {
          setLoading(false);
        }
      };

      const confirmPayment = async () => {
        if (!user || !paymentData) {
          setError('Данные для подтверждения оплаты отсутствуют');
          return;
        }
        setLoading(true);
        setError(null);
        try {
          const response = await axios.post(`${API_URL}/api/confirm-payment`, {
            tg_id: user.telegram_id,
            label: paymentData.label
          });
          console.log('Confirm payment response:', response.data);
          if (response.data.success) {
            setView('subscriptions');
            fetchSubscriptions();
            Telegram.WebApp.showAlert(
              paymentData.isExtension 
                ? 'Подписка успешно продлена!' 
                : 'Подписка успешно активирована!'
            );
            setPaymentData(null);
          }
        } catch (err) {
          console.error('Confirm payment error:', err);
          setError(`Ошибка подтверждения оплаты: ${err.response?.data?.detail || err.message}`);
        } finally {
          setLoading(false);
        }
      };

      const cancelPayment = async () => {
        if (!user || !paymentData) {
          setError('Данные для отмены оплаты отсутствуют');
          return;
        }
        setLoading(true);
        setError(null);
        try {
          console.log('Cancel payment request:', { tg_id: user.telegram_id, label: paymentData.label });
          await axios.delete(`${API_URL}/api/cancel-payment`, {
            data: { tg_id: user.telegram_id, label: paymentData.label }
          });
          setPaymentData(null);
          setView('subscriptions');
          Telegram.WebApp.showAlert('Оплата отменена');
        } catch (err) {
          console.error('Cancel payment error:', err);
          setError(`Ошибка отмены оплаты: ${err.response?.data?.detail || err.message}`);
        } finally {
          setLoading(false);
        }
      };

      const Header = ({ title, onBack }) =>
        h('div', { className: 'header' }, [
          onBack && h('button', { className: 'back-button', onClick: onBack }, '←'),
          h('div', { className: 'header-title' }, title),
          onBack && h('div', { style: { width: '40px' } }),
        ]);

      const renderMainMenu = () =>
        h('div', { className: 'container' }, [
          Header({ title: 'WSocks VPN' }),
          h('div', { className: 'content' }, [
            h('div', { className: 'logo' }, h('div', { className: 'logo-text' }, 'WSocks VPN')),
            user && h('p', { style: { marginBottom: '16px', textAlign: 'center', fontSize: '16px' } }, `Welcome, ${user.first_name}!`),
            error && h('p', { className: 'error' }, error),
            h('div', { className: 'tooltip' }, [
              h('button', { className: 'button button-primary', onClick: () => setView('referrals') }, [
                h('span', { className: 'button-icon' }, '👥'),
                'Referral System',
              ]),
              h('span', { className: 'tooltip-text' }, 'Invite friends for rewards'),
            ]),
            h('div', { className: 'tooltip' }, [
              h('button', { className: 'button button-primary', onClick: fetchSubscriptions }, [
                h('span', { className: 'button-icon' }, '🛒'),
                'Subscriptions',
              ]),
              h('span', { className: 'tooltip-text' }, 'Manage your subscriptions'),
            ]),
            h('div', { className: 'tooltip' }, [
              h('button', { className: 'button button-primary', onClick: () => setView('info') }, [
                h('span', { className: 'button-icon' }, '📌'),
                'Information',
              ]),
              h('span', { className: 'tooltip-text' }, 'Learn about WSocks VPN'),
            ]),
            h('div', { className: 'tooltip' }, [
              h('button', { className: 'button button-primary', onClick: () => window.open('https://t.me/WSocks_Support') }, [
                h('span', { className: 'button-icon' }, '❤️'),
                'Support Telegram',
              ]),
              h('span', { className: 'tooltip-text' }, 'Contact our support team'),
            ]),
          ]),
        ]);

      const renderReferrals = () =>
        h('div', { className: 'container' }, [
          Header({ title: 'Referral System', onBack: () => setView('main') }),
          h('div', { className: 'content' }, [
            error && h('p', { className: 'error' }, error),
            h('p', { className: 'card' }, ['Invite friends and get ', h('b', null, '7 days'), ' free:']),
            h('p', { className: 'card' }, 'Referral system not implemented yet.'),
            h('button', { className: 'button button-secondary', onClick: () => setView('main') }, 'Back'),
          ]),
        ]);

      const renderSubscriptions = () =>
        h('div', { className: 'container' }, [
          Header({ title: 'Subscriptions', onBack: () => setView('main') }),
          h('div', { className: 'content' }, [
            error && h('p', { className: 'error' }, error),
            loading && h('p', { className: 'loading' }, 'Loading...'),
            !loading && subscriptions.length === 0 && h('p', { className: 'card' }, 'No active subscriptions.'),
            subscriptions.map((sub, index) =>
              h('div', { key: index, className: 'card' }, [
                h('p', null, [h('b', null, 'Email: '), sub.email]),
                h('p', null, [h('b', null, 'Panel: '), sub.panel]),
                h('p', null, [h('b', null, 'Expiry: '), new Date(sub.expiry_date).toLocaleString()]),
                h('p', null, [h('b', null, 'Status: '), sub.is_expired ? 'Expired' : 'Active']),
                h('div', { style: { display: 'flex', gap: '8px', marginTop: '8px' } }, [
                  h('button', { className: 'button button-success', onClick: () => { setSelectedSub(sub); setView('extend'); } }, 'Extend'),
                  h('button', { className: 'button button-primary', onClick: () => { setSelectedSub(sub); setView('setup'); } }, 'Setup Guide'),
                ]),
              ])
            ),
            h('button', { className: 'button button-primary', onClick: () => setView('buy') }, [
              h('span', { className: 'button-icon' }, '💳'),
              'Buy Subscription',
            ]),
            h('button', { className: 'button button-secondary', onClick: () => setView('main') }, 'Back'),
          ]),
        ]);

      const renderBuy = () =>
        h('div', { className: 'container' }, [
          Header({ title: 'Buy Subscription', onBack: () => setView('subscriptions') }),
          h('div', { className: 'content' }, [
            error && h('p', { className: 'error' }, error),
            h('button', { className: 'button button-primary', onClick: () => initiatePayment(30) }, [
              '30 Days - 89 RUB',
            ]),
            h('button', { className: 'button button-primary', onClick: () => initiatePayment(90) }, [
              '90 Days - 249 RUB',
            ]),
            h('button', { className: 'button button-primary', onClick: () => initiatePayment(180) }, [
              '180 Days - 449 RUB',
            ]),
            h('button', { className: 'button button-primary', onClick: () => initiatePayment(360) }, [
              '360 Days - 849 RUB',
            ]),
            h('button', { className: 'button button-secondary', onClick: () => setView('subscriptions') }, 'Back'),
          ]),
        ]);

      const renderExtend = () =>
        h('div', { className: 'container' }, [
          Header({ title: 'Extend Subscription', onBack: () => setView('subscriptions') }),
          h('div', { className: 'content' }, [
            error && h('p', { className: 'error' }, error),
            h('p', { className: 'card' }, [h('b', null, 'Email: '), selectedSub.email]),
            h('button', { className: 'button button-primary', onClick: () => initiatePayment(30, true, selectedSub.email) }, [
              'Extend 30 Days - 89 RUB',
            ]),
            h('button', { className: 'button button-primary', onClick: () => initiatePayment(90, true, selectedSub.email) }, [
              'Extend 90 Days - 249 RUB',
            ]),
            h('button', { className: 'button button-primary', onClick: () => initiatePayment(180, true, selectedSub.email) }, [
              'Extend 180 Days - 449 RUB',
            ]),
            h('button', { className: 'button button-primary', onClick: () => initiatePayment(360, true, selectedSub.email) }, [
              'Extend 360 Days - 849 RUB',
            ]),
            h('button', { className: 'button button-secondary', onClick: () => setView('subscriptions') }, 'Back'),
          ]),
        ]);

      const renderPayment = () =>
        h('div', { className: 'container' }, [
          Header({ title: 'Payment', onBack: cancelPayment }),
          h('div', { className: 'content' }, [
            error && h('p', { className: 'error' }, error),
            paymentData && h('p', { className: 'card' }, `Cost for ${paymentData.days} days: ${paymentData.amount} RUB`),
            paymentData && h('p', { className: 'card' }, [h('b', null, 'User: '), paymentData.email]),
            paymentData && h('a', { href: paymentData.payment_link, target: '_blank', className: 'button button-success' }, [
              h('span', { className: 'button-icon' }, '💸'),
              'Pay',
            ]),
            paymentData && h('button', { className: 'button button-primary', onClick: confirmPayment }, [
              h('span', { className: 'button-icon' }, '✅'),
              'Confirm Payment',
            ]),
            paymentData && h('button', { className: 'button button-danger', onClick: cancelPayment }, [
              h('span', { className: 'button-icon' }, '❌'),
              'Cancel',
            ]),
          ]),
        ]);

      const renderSetup = () =>
        h('div', { className: 'container' }, [
          Header({ title: 'Setup Guide', onBack: () => setView('subscriptions') }),
          h('div', { className: 'content' }, [
            error && h('p', { className: 'error' }, error),
            h('p', { className: 'card' }, [h('b', null, 'Email: '), selectedSub.email]),
            h('button', { className: 'button button-primary', onClick: () => window.open('https://plvideo.ru/watch?v=1') }, [
              h('span', { className: 'button-icon' }, '💻'),
              'PC Guide',
            ]),
            h('button', { className: 'button button-primary', onClick: () => window.open('https://plvideo.ru/watch?v=2') }, [
              h('span', { className: 'button-icon' }, '📱'),
              'Android Guide',
            ]),
            h('button', { className: 'button button-primary', onClick: () => window.open('https://plvideo.ru/watch?v=3') }, [
              h('span', { className: 'button-icon' }, '🍏'),
              'iOS/MacOS Guide',
            ]),
            h('button', { className: 'button button-primary', onClick: () => Telegram.WebApp.showAlert('See bot for Android TV guide.') }, [
              h('span', { className: 'button-icon' }, '📺'),
              'Android TV Guide',
            ]),
            h('button', { className: 'button button-secondary', onClick: () => setView('subscriptions') }, 'Back'),
          ]),
        ]);

      const renderInfo = () =>
        h('div', { className: 'container' }, [
          Header({ title: 'Information', onBack: () => setView('main') }),
          h('div', { className: 'content' }, [
            error && h('p', { className: 'error' }, error),
            h('button', { className: 'button button-primary', onClick: () => setView('service') }, [
              h('span', { className: 'button-icon' }, '🌐'),
              'About Service',
            ]),
            h('button', { className: 'button button-primary', onClick: () => setView('subscription') }, [
              h('span', { className: 'button-icon' }, '📋'),
              'About Subscription',
            ]),
            h('button', { className: 'button button-primary', onClick: () => setView('terms') }, [
              h('span', { className: 'button-icon' }, '📜'),
              'User Agreement',
            ]),
            h('button', { className: 'button button-primary', onClick: () => setView('privacy') }, [
              h('span', { className: 'button-icon' }, '🔒'),
              'Privacy Policy',
            ]),
            h('button', { className: 'button button-secondary', onClick: () => setView('main') }, 'Back'),
          ]),
        ]);

      const renderService = () =>
        h('div', { className: 'container' }, [
          Header({ title: 'About Service', onBack: () => setView('info') }),
          h('div', { className: 'content' }, [
            error && h('p', { className: 'error' }, error),
            h('p', { className: 'card' }, 'WSocks VPN provides secure internet browsing via servers in Germany. We ensure data privacy, stability, and speed. Our service uses modern TLS+Vless+TCP+Reality protocols and supports multiple apps.'),
            h('button', { className: 'button button-secondary', onClick: () => setView('info') }, 'Back'),
          ]),
        ]);

      const renderSubscription = () =>
        h('div', { className: 'container' }, [
          Header({ title: 'About Subscription', onBack: () => setView('info') }),
          h('div', { className: 'content' }, [
            error && h('p', { className: 'error' }, error),
            h('div', { className: 'card' }, [
              h('p', null, [h('b', null, 'Cost:'), ' 89 RUB/month']),
              h('p', null, [h('b', null, 'Speed Limit:'), ' None']),
              h('p', null, [h('b', null, 'Traffic Limit:'), ' Unlimited']),
              h('p', null, [h('b', null, 'Protocols:'), ' TLS+Vless']),
              h('p', null, [h('b', null, 'Apps:'), ' Amnesia, NekoBox']),
              h('p', null, [h('b', null, 'Max Devices:'), ' 3']),
              h('p', null, [h('b', null, 'Note:'), ' Add games or torrents to exclusions to avoid speed throttling.']),
            ]),
            h('button', { className: 'button button-secondary', onClick: () => setView('info') }, 'Back'),
          ]),
        ]);

      const renderTerms = () =>
        h('div', { className: 'container' }, [
          Header({ title: 'User Agreement', onBack: () => setView('info') }),
          h('div', { className: 'content' }, [
            error && h('p', { className: 'error' }, error),
            h('p', { className: 'card' }, 'By using WSocks VPN, you agree to comply with Russian laws, avoid bypassing blocks, and not engage in illegal activities. We reserve the right to suspend access for violations.'),
            h('button', { className: 'button button-secondary', onClick: () => setView('info') }, 'Back'),
          ]),
        ]);

      const renderPrivacy = () =>
        h('div', { className: 'container' }, [
          Header({ title: 'Privacy Policy', onBack: () => setView('info') }),
          h('div', { className: 'content' }, [
            error && h('p', { className: 'error' }, error),
            h('p', { className: 'card' }, 'WSocks VPN respects your privacy and uses Telegram-provided data. See details at:'),
            h('button', { className: 'button button-primary', onClick: () => window.open('https://telegra.ph/Politika-konfidencialnosti-08-04-7') }, [
              h('span', { className: 'button-icon' }, '🔗'),
              'Open Policy',
            ]),
            h('button', { className: 'button button-secondary', onClick: () => setView('info') }, 'Back'),
          ]),
        ]);

      const views = {
        main: renderMainMenu,
        referrals: renderReferrals,
        subscriptions: renderSubscriptions,
        buy: renderBuy,
        extend: renderExtend,
        payment: renderPayment,
        setup: renderSetup,
        info: renderInfo,
        service: renderService,
        subscription: renderSubscription,
        terms: renderTerms,
        privacy: renderPrivacy,
      };

      return user
        ? h('div', null, views[view]())
        : h('div', { className: 'container' }, [
            Header({ title: 'WSocks VPN' }),
            h('div', { className: 'content' }, h('p', { className: 'loading' }, 'Loading user data...')),
          ]);
    }

    ReactDOM.render(h(App), document.getElementById('root'));
  </script>
</body>
</html>
