<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WSocks VPN Mini App</title>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.7.2/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@twa-dev/sdk@7.10.0/dist/telegram-web-apps.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f0f0f0;
    }
    .container {
      max-width: 400px;
      margin: 0 auto;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 20px;
    }
    p {
      margin-bottom: 10px;
    }
    .error {
      color: red;
    }
    button {
      padding: 10px;
      width: 100%;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      background-color: #28a745;
      color: white;
    }
    button:disabled {
      background-color: #ccc;
    }
  </style>
</head>
<body>
  <div className="container" id="app">
    <h1>WSocks VPN</h1>
    <p id="user-id">Загрузка...</p>
    <p id="error" class="error"></p>
    <h2>Пробная подписка</h2>
    <p id="status">Проверка статуса...</p>
    <button id="activate-btn" disabled>Активировать пробный период</button>
  </div>
  <script>
    console.log('App starting...');
    console.log('Telegram SDK:', window.Telegram?.WebApp);
    console.log('axios:', typeof axios);

    const app = document.getElementById('app');
    const userId = document.getElementById('user-id');
    const error = document.getElementById('error');
    const status = document.getElementById('status');
    const activateBtn = document.getElementById('activate-btn');

    try {
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
      const initData = Telegram.WebApp.initData;
      console.log('InitData:', initData);
      console.log('User:', Telegram.WebApp.initDataUnsafe.user);

      if (!initData) {
        error.textContent = 'Не удалось инициализировать Telegram Web App';
        return;
      }

      // Аутентификация пользователя
      axios.post('https://your-backend.onrender.com/api/auth', { initData })
        .then(({ data }) => {
          console.log('Auth response:', data);
          userId.textContent = `ID: ${data.user.telegram_id}`;

          // Проверка статуса пробного периода
          axios.get(`https://your-backend.onrender.com/api/trial/status?tg_id=${data.user.telegram_id}`)
            .then(({ data }) => {
              console.log('Trial status response:', data);
              if (data.status === 1) {
                status.textContent = `Пробный период активирован! Ключ: ${data.key}`;
                activateBtn.style.display = 'none';
              } else {
                status.textContent = 'Пробный период доступен';
                activateBtn.disabled = false;
              }
            })
            .catch(err => {
              console.error('Trial status error:', err);
              error.textContent = 'Ошибка при проверке пробного периода: ' + (err.response?.data?.detail || err.message);
            });

          // Обработчик активации
          activateBtn.addEventListener('click', () => {
            activateBtn.disabled = true;
            activateBtn.textContent = 'Активация...';
            axios.post('https://your-backend.onrender.com/api/trial/activate', { tg_id: data.user.telegram_id })
              .then(({ data }) => {
                console.log('Activate trial response:', data);
                status.textContent = `Пробный период активирован! Ключ: ${data.key}`;
                activateBtn.style.display = 'none';
                Telegram.WebApp.showAlert('Пробный период активирован!');
              })
              .catch(err => {
                console.error('Activate trial error:', err);
                error.textContent = err.response?.data?.detail || 'Ошибка активации';
                activateBtn.disabled = false;
                activateBtn.textContent = 'Активировать пробный период';
              });
          });
        })
        .catch(err => {
          console.error('Auth error:', err);
          error.textContent = 'Ошибка авторизации: ' + (err.response?.data?.detail || err.message);
        });
    } catch (e) {
      console.error('General error:', e);
      error.textContent = 'Ошибка инициализации: ' + e.message;
    }
  </script>
</body>
</html>
